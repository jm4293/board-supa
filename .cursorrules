# AI Coding Rules & Guidelines

## 프로젝트 개요

- **Stack**: Next.js 16, TypeScript, Supabase, Tailwind CSS
- **구조**: App Router 기반 Next.js 프로젝트
- **데이터베이스**: Supabase (PostgreSQL)
- **주 컬러**: 파란색 (Blue)

## 코딩 스타일

### TypeScript

- **타입 안정성**: `any` 사용 금지, 명시적 타입 정의 필수
- **Null 처리**: `null`과 `undefined`를 명확히 구분
- **인터페이스**: Model과 별도로 Request/Response 타입 정의

### 네이밍 컨벤션

- **파일명**: kebab-case (예: `board-write-form.tsx`)
- **컴포넌트**: PascalCase (예: `BoardWriteForm`)
- **함수/변수**: camelCase (예: `getUserById`)
- **상수**: UPPER_SNAKE_CASE (예: `MAX_RETRY_COUNT`)
- **Interface**: PascalCase + Model 접미사 (예: `UserModel`, `BoardModel`)

## 프로젝트 구조 규칙

### 폴더 구조

```
app/                    # Next.js App Router (페이지, 레이아웃, Server Actions)
  (main)/               # 메인 레이아웃 그룹
    board/              # 게시판 관련 페이지
      write/
        actions.ts      # Server Actions
        BoardWriteForm.tsx
  auth/                 # 인증 관련 페이지
component/              # React 컴포넌트
  common/               # 공통 컴포넌트
config/                 # 설정 파일
  supabase/            # Supabase 클라이언트 설정
database/
  model/            # 데이터베이스 모델 (TypeScript Interface)
public/                # 정적 파일
service/               # 비즈니스 로직 서비스 레이어
  {domain}/            # 도메인별 폴더 (예: user, board)
    action/            # Server Actions
      {action-name}.action.ts
    mutation/          # React Query Mutations
      use{Mutation}Mutation.tsx
    model/             # 도메인별 Model (선택사항)
share/                 # 공유 리소스
  utils/               # 유틸리티 함수
  const/               # 상수 정의
  type/                # 공통 타입 정의
    response.type.ts   # ResponseType 정의
```

### 데이터베이스 모델 규칙

#### Model 작성

- 파일명: PascalCase (예: `User.ts`, `BoardComment.ts`)
- TypeScript Interface로 정의
- snake_case DB 컬럼명을 camelCase로 매핑: `name: "profile_image"` → `profileImage`
- Model 접미사 사용: `UserModel`, `BoardModel`
- nullable 필드는 `| null` 타입 명시

**예시**:

```typescript
// database/entities/User.ts
export interface UserModel {
  id: number;
  username: string;
  nickname: string | null;
  profileImage: string | null;
  status: number | null;
  createdAt: Date | null;
  updatedAt: Date | null;
}
```

### Supabase 사용 규칙

#### 클라이언트 생성

- **Server Component / Server Actions**: `createClient()` from `@/config/supabase/server` 사용
- **Client Component**: `createBrowserClient()` from `@supabase/ssr` 사용

#### 쿼리 작성

- `.select()` 사용 시 필요한 컬럼만 명시
- `.eq()`, `.neq()`, `.gt()`, `.lt()` 등 필터 메서드 활용
- `.order()` 사용하여 정렬
- `.range()` 사용하여 페이지네이션
- 에러 처리 필수

**예시**:

```typescript
const { data, error } = await supabase
  .from('Board')
  .select('id, title, content, created_at')
  .eq('is_deleted', 0)
  .order('created_at', { ascending: false })
  .range(0, 9);

if (error) {
  throw new Error(error.message);
}
```

### API 라우트 규칙

- 파일 위치: `app/api/{resource}/route.ts` (필요시)
- HTTP 메서드별 함수: `GET`, `POST`, `PUT`, `PATCH`, `DELETE`
- 응답 형식:
  ```typescript
  return Response.json({ data, message }, { status: 200 });
  ```
- 에러 처리:
  ```typescript
  return Response.json({ error: message }, { status: 400 });
  ```

### Form 처리 규칙 (React Hook Form + Zod)

- **폼 검증**: Zod 스키마로 정의, `zodResolver` 사용
- **Form 컴포넌트**: Client Component (`'use client'`)
- **데이터 전달**: FormData로 변환하여 Mutation에 전달
- **에러 처리**: `formState.errors`로 에러 표시

**예시**:

```typescript
'use client';

import { zodResolver } from '@hookform/resolvers/zod';
import { useForm } from 'react-hook-form';
import { z } from 'zod';

const formSchema = z.object({
  email: z.string().email('올바른 이메일 형식이 아닙니다'),
  password: z.string().min(4, '비밀번호는 최소 4자리 이상이어야 합니다'),
});

type FormValues = z.infer<typeof formSchema>;

export default function AuthLoginForm() {
  const {
    register,
    handleSubmit,
    formState: { errors },
  } = useForm<FormValues>({
    resolver: zodResolver(formSchema),
  });

  const { loginUser } = useUserMutation();

  const onSubmit = (data: FormValues) => {
    const formData = new FormData();
    formData.append('email', data.email);
    formData.append('password', data.password);

    loginUser.mutate(formData);
  };

  return (
    <form onSubmit={handleSubmit(onSubmit)}>
      {/* 폼 필드 */}
    </form>
  );
}
```

### Mutation 규칙 (React Query)

- **파일 위치**: `service/{domain}/mutation/use{Mutation}Mutation.tsx`
- **패턴**: `@tanstack/react-query`의 `useMutation` 사용
- **Server Action 연결**: `mutationFn`에 Server Action 전달
- **에러/성공 처리**: `onSuccess`, `onError` 콜백 사용

**예시**:

```typescript
import { useMutation } from '@tanstack/react-query';
import { useRouter } from 'next/navigation';

import { loginUserAction } from '../action';

export const useUserMutation = () => {
  const router = useRouter();

  const loginUser = useMutation({
    mutationFn: (formData: FormData) => loginUserAction(formData),
    onSuccess: (response) => {
      const { success, message } = response;

      if (!success) {
        alert(message);
        return;
      }

      alert('로그인이 완료되었습니다.');
      router.push('/home');
    },
    onError: (error) => {
      throw error;
    },
  });

  return {
    loginUser,
  };
};
```

### Server Actions 규칙

- **파일 위치**: `service/{domain}/action/{action-name}.action.ts`
- **디렉티브**: `'use server'` 필수
- **파라미터**: FormData 또는 명시적 타입으로 받기
- **반환 타입**: `ResponseType<T>` 사용
- **에러 처리**: try-catch 블록 필수

**예시**:

```typescript
'use server';

import { createClient } from '@/config/supabase/server';
import { ResponseType } from '@/share/type/response.type';

export const loginUserAction = async (formData: FormData): Promise<ResponseType> => {
  const email = formData.get('email') as string;
  const password = formData.get('password') as string;

  const supabase = await createClient();

  try {
    // 작업 수행
    return {
      success: true,
      data: null,
      message: null,
    };
  } catch (error) {
    throw error;
  }
};
```

### 컴포넌트 규칙

- Server Component 기본, Client Component는 `"use client"` 명시
- Props 인터페이스는 컴포넌트 위에 정의
- 스타일: Tailwind CSS 사용, 인라인 클래스 작성

### 데이터베이스 규칙

- 테이블명: PascalCase (예: `User`, `Board`, `BoardComment`)
- 컬럼명: snake_case (예: `user_id`, `created_at`, `is_deleted`)
- Primary Key: `id` (bigserial)
- 타임스탬프: `created_at`, `updated_at` 필수
- Soft Delete: `is_deleted` (smallint, 0/1), `deleted_at` (timestamp)
- 인덱스: 검색/조인이 빈번한 컬럼에 설정

## API 요청 처리 패턴

### 전체 흐름

1. **Form 컴포넌트** (Client Component)
   - React Hook Form + Zod로 폼 검증
   - FormData로 변환하여 Mutation 호출

2. **Mutation Hook** (`service/{domain}/mutation/`)
   - React Query의 `useMutation` 사용
   - Server Action을 `mutationFn`으로 연결
   - 성공/실패 처리 로직 포함

3. **Server Action** (`service/{domain}/action/`)
   - `'use server'` 디렉티브
   - FormData를 받아 비즈니스 로직 처리
   - `ResponseType<T>` 반환

### 패턴 예시

```
Form Component → Mutation Hook → Server Action → Supabase
```

## 주의사항

- **비동기 처리**: async/await 사용, Promise 체이닝 지양
- **에러 핸들링**: try-catch 블록 필수, 의미 있는 에러 메시지
- **보안**: 환경변수로 민감 정보 관리 (`.env.local`)
- **Supabase RLS**: Row Level Security 정책 설정 권장
- **타입 안정성**: Supabase 쿼리 결과에 타입 캐스팅 사용
- **코드 품질**: ESLint 규칙 준수, 불필요한 console.log 제거
- **redirect 에러**: `NEXT_REDIRECT` 에러는 정상 동작이므로 다시 throw
- **Form 처리**: 모든 폼은 React Hook Form + Zod + Mutation 패턴 사용
- **Server Action**: 직접 호출하지 않고 Mutation을 통해 호출

## 커밋 메시지

- feat: 새로운 기능
- fix: 버그 수정
- refactor: 리팩토링
- docs: 문서 수정
- style: 코드 포맷팅
- test: 테스트 추가/수정
- chore: 빌드/설정 변경
